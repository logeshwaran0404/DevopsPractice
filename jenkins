pipeline {
    agent any
    
    tools {
        maven 'Maven 3.9.6'
        jdk 'JDK 17'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean package'
                archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
            }
        }
        
        stage('Test') {
            steps {
                sh 'mvn test'
                junit '**/target/surefire-reports/TEST-*.xml'
            }
        }
        
        stage('Deploy') {
            steps {
                sh '''
                    # Stop the current application if running
                    if pgrep -f "demo-0.0.1-SNAPSHOT.jar" > /dev/null; then
                        pkill -f "demo-0.0.1-SNAPSHOT.jar"
                        echo "Stopped existing application"
                        sleep 5
                    fi
                    
                    # Start the new version
                    nohup java -jar target/demo-0.0.1-SNAPSHOT.jar > app.log 2>&1 &
                    echo "Started new application version"
                '''
            }
        }
    }
    
    post {
        success {
            echo 'Build and deployment successful!'
        }
        failure {
            echo 'Build or deployment failed!'
            
            // Send email notification on failure
            emailext (
                subject: "BUILD FAILED: ${currentBuild.fullDisplayName}",
                body: """
                    <p>BUILD FAILED: ${currentBuild.fullDisplayName}</p>
                    <p>SCM checkout or build process failed</p>
                    <p>Check the console output at: ${env.BUILD_URL}console</p>
                    <p>Failed Stage: ${currentBuild.result}</p>
                """,
                recipientProviders: [
                    [$class: 'DevelopersRecipientProvider'],
                    [$class: 'RequesterRecipientProvider']
                ],
                to: 'logeshwaran7129@gmail.com',
                mimeType: 'text/html'
            )
        }
        always {
            cleanWs()
        }
    }
}